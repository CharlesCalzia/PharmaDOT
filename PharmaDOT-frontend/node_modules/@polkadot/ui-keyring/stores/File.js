import mkdirp from 'mkdirp';
import fs from 'node:fs';
import path from 'node:path';
export class FileStore {
    constructor(path) {
        if (!fs.existsSync(path)) {
            mkdirp.sync(path);
        }
        this.__internal__path = path;
    }
    all(fn) {
        fs
            .readdirSync(this.__internal__path)
            .filter((key) => !['.', '..', '.DS_Store'].includes(key))
            .forEach((key) => {
            const value = this._readKey(key);
            value?.address && fn(key, value);
        });
    }
    get(key, fn) {
        const value = this._readKey(key);
        if (!value?.address) {
            throw new Error(`Invalid JSON found for ${key}`);
        }
        fn(value);
    }
    remove(key, fn) {
        fs.unlinkSync(this._getPath(key));
        fn && fn();
    }
    set(key, value, fn) {
        fs.writeFileSync(this._getPath(key), Buffer.from(JSON.stringify(value), 'utf-8'));
        fn && fn();
    }
    _getPath(key) {
        return path.join(this.__internal__path, key);
    }
    _readKey(key) {
        try {
            return JSON.parse(fs.readFileSync(this._getPath(key)).toString('utf-8'));
        }
        catch (error) {
            console.error(error);
        }
        return undefined;
    }
}
